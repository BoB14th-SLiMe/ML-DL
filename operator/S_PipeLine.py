#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import time
import argparse
from copy import deepcopy

# ------------------------------------------------------------
# 1) ì™¸ë¶€ ëª¨ë“ˆ ì„í¬íŠ¸: RedisPopServer (Redisì—ì„œ ë°ì´í„° êº¼ë‚´ì£¼ëŠ” ë„ìš°ë¯¸)
# - S_server.py íŒŒì¼ì´ ê°™ì€ ë””ë ‰í† ë¦¬ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
# - ì—†ë‹¤ë©´ ì¹œì ˆí•˜ê²Œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë‚´ê³  ì¢…ë£Œí•©ë‹ˆë‹¤.
# ------------------------------------------------------------
try:
    # S_server.py ì•ˆì— RedisPopServer í´ë˜ìŠ¤ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    # ì—­í• : Redisì™€ ì—°ê²°í•´, ì œì¼ ì˜¤ë˜ëœ ë°ì´í„°ë¥¼ í•˜ë‚˜ ë¹¼ì˜¤ëŠ” pop_oldest() ì œê³µ.
    from S_server import RedisPopServer
except ImportError:
    # íŒŒì¼ì´ ì—†ê±°ë‚˜, ê²½ë¡œ ë¬¸ì œê°€ ìˆê±°ë‚˜, ë‚´ë¶€ import ì—ëŸ¬ê°€ ìˆì„ ë•Œ ì—¬ê¸°ë¡œ ì˜µë‹ˆë‹¤.
    print("âŒ ERROR: S_server.py íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit(1)

# ------------------------------------------------------------
# 2) ì™¸ë¶€ ëª¨ë“ˆ ì„í¬íŠ¸: ML/DL ì²˜ë¦¬ í•¨ìˆ˜ë“¤
# - ML_start: ë‹¨ì¼ ë°ì´í„°ìš© ê°„ë‹¨ ML íŒë‹¨
# - DL_start, DL_reset, SEQ_LEN: ìˆœì°¨ ë°ì´í„°ìš© DL íŒë‹¨ + ë‚´ë¶€ë²„í¼ ì´ˆê¸°í™” + í•„ìš”í•œ ìœˆë„ìš° í¬ê¸°
# ------------------------------------------------------------
try:
    from ML_start import ML_start

    from DL_start import DL_start
except ImportError:
    print("âŒ ERROR: ML_start.py ë˜ëŠ” DL_start.py íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit(1)

# ------------------------------------------------------------
# [ì„¤ì •] íŒŒì´í”„ë¼ì¸ì´ ì‚¬ìš©í•  ìœˆë„ìš° í¬ê¸°
# - DL_start.py ì•ˆì˜ SEQ_LEN ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
# - ì´ ê°’ë§Œí¼ ë°ì´í„°ê°€ ëª¨ì—¬ì•¼ DLì´ 'ready=True'ë¡œ íŒë‹¨ ê²°ê³¼ë¥¼ ëƒ…ë‹ˆë‹¤.
# ------------------------------------------------------------
PIPELINE_WINDOW_SIZE = 80


def print_safe(data):
    """
    ì•ˆì „í•œ ì¶œë ¥ í•¨ìˆ˜:
    - ì¼ë°˜ì ìœ¼ë¡œ dict, list ê°™ì€ ìë£ŒëŠ” json.dumps ë¡œ ì˜ˆì˜ê²Œ(ë“¤ì—¬ì“°ê¸°) ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - ê·¸ëŸ°ë° ì„¸ìƒì—ëŠ” jsonìœ¼ë¡œ ë°”ë¡œ ë³€í™˜ì´ ì•ˆ ë˜ëŠ” íŠ¹ìˆ˜ ê°ì²´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      (ì˜ˆ: datetime, custom class ë“±)
    - ê·¸ëŸ° ê²½ìš°ì—ë„ 'ê¸°ë³¸ ë¬¸ìì—´ í‘œí˜„'ì´ë¼ë„ ì¶œë ¥í•˜ë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    """
    try:
        # ensure_ascii=False: í•œê¸€ì´ ê¹¨ì§€ì§€ ì•Šê²Œ ê·¸ëŒ€ë¡œ ì¶œë ¥
        # default=str: jsonì´ ëª¨ë¥´ëŠ” íƒ€ì…ì´ ë‚˜ì˜¤ë©´ str()ë¡œ ë°”ê¿”ì„œ ì¶œë ¥
        print(json.dumps(data, indent=2, ensure_ascii=False, default=str))
    except Exception:
        # ê·¸ë˜ë„ ì•ˆ ë˜ë©´ ê·¸ëƒ¥ repr()ë¡œ ëŒ€ì¶©ì´ë¼ë„ ë³´ì—¬ì¤ë‹ˆë‹¤.
        print(repr(data))


class SequentialPipeLine:
    """
    SequentialPipeLine í´ë˜ìŠ¤:
    - 'ìˆœì°¨ íŒŒì´í”„ë¼ì¸'ì´ë¼ëŠ” ëœ». ë“¤ì–´ì˜¨ ë°ì´í„°ë¥¼ ë‹¨ê³„ë³„ë¡œ(ìˆœì„œëŒ€ë¡œ) ì²˜ë¦¬í•©ë‹ˆë‹¤.

    ì²˜ë¦¬ ë‹¨ê³„(ì¤‘ìš”!):
    1) RedisPopServer.pop_oldest()ë¡œ ê°€ì¥ ì˜¤ë˜ëœ ë°ì´í„° í•˜ë‚˜ êº¼ëƒ„
       - ì´ë•Œ ë°ì´í„°ëŠ” {'origin': {...ì›ë³¸...}} í˜•íƒœë¡œ ê°ì‹¸ì ¸ ìˆìŠµë‹ˆë‹¤.
    2) ML_start(origin) ìˆ˜í–‰
       - ë¹ ë¥¸ 1ì°¨ íŒë‹¨ ê²°ê³¼ë¥¼ wrapped_data['ml']ì— ì €ì¥í•©ë‹ˆë‹¤.
    3) DL_start(origin) ìˆ˜í–‰
       - ë‚´ë¶€ ìƒíƒœ(ìµœê·¼ ë°ì´í„°ë“¤)ë¥¼ ì´ìš©í•´, Nê°œê°€ ëª¨ì˜€ì„ ë•Œë§Œ íŒë‹¨ ê²°ê³¼ë¥¼ ëƒ…ë‹ˆë‹¤.
       - ì•„ì§ ëª¨ìë¼ë©´ ready=Falseì´ë¯€ë¡œ ë‹¤ìŒ ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
    4) DL ê²°ê³¼(label) í™•ì¸
       - "ğŸ”´ Anomaly" ë¼ëŠ” ë‹¨ì–´ê°€ labelì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì´ìƒ(O),
         ì•„ë‹ˆë©´ ì •ìƒ(X)ìœ¼ë¡œ ì·¨ê¸‰í•©ë‹ˆë‹¤.
    5) ì´ìƒ(O)ì¸ ê²½ìš°
       - 'ë°”ë¡œ ì§€ê¸ˆ' ìœˆë„ìš°ì— ë“¤ì–´ìˆëŠ” Nê°œ ë¬¶ìŒì„ ìº¡ì²˜í•´,
         ê° í•­ëª©ì— ë™ì¼í•œ DL ê²°ê³¼ë¥¼ ë³‘í•©í•œ ë¦¬ìŠ¤íŠ¸ë¥¼ SLM í¬ë§·ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
    6) ì •ìƒ(X)ì¸ ê²½ìš°
       - ê·¸ ë¬¶ìŒì€ ë“œëí•˜ê³  ë‹¤ìŒ ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.

    ì£¼ì˜í•  ì :
    - DL_start.py ë‚´ë¶€ë„ ë²„í¼(ìµœê·¼ ë°ì´í„°)ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
    - ì´ í´ë˜ìŠ¤ë„ ë™ì¼í•œ ê¸¸ì´ì˜ ë²„í¼ë¥¼ 'ë¯¸ëŸ¬ë§'í•´ì„œ,
      DLì´ íŒë‹¨í•œ ê·¸ 'ì‹œì 'ì˜ Nê°œ ë¬¶ìŒì„ ì •í™•íˆ ì¬í˜„í•©ë‹ˆë‹¤.
    """

    def __init__(self, host, port, db, password):
        """
        íŒŒì´í”„ë¼ì¸ì„ ë§Œë“¤ ë•Œ í•˜ëŠ” ì¼:
        - RedisPopServerë¥¼ ì´ˆê¸°í™”í•˜ì—¬ Redisì— ì—°ê²° ì¤€ë¹„í•©ë‹ˆë‹¤.
        - íŒŒì´í”„ë¼ì¸ ë‚´ë¶€ ë²„í¼(self.data_buffer)ë¥¼ ë¹„ì›Œ ì‹œì‘í•©ë‹ˆë‹¤.
        - DL ë‚´ë¶€ ë²„í¼ë¥¼ ì´ˆê¸°í™”(DL_reset)í•˜ì—¬ DLê³¼ íŒŒì´í”„ë¼ì¸ì˜ 'ì‹œì‘ì 'ì„ ë§ì¶¥ë‹ˆë‹¤.
        - ìœˆë„ìš° í¬ê¸°(SEQ_LEN)ë¥¼ ê¸°ë¡í•´ë‘¡ë‹ˆë‹¤.
        """
        # 1) Redisì— ì—°ê²°í•  ì¤€ë¹„
        print("1. [S_server] ëª¨ë“ˆ ë¡œë”© ë° Redis ì—°ê²° ì‹œë„...")
        # RedisPopServerëŠ” host, port, db, password ì •ë³´ë¡œ Redisì— ì ‘ê·¼í•©ë‹ˆë‹¤.
        self.server = RedisPopServer(
            host=host, port=port, db=db, password=password
        )

        # 2) íŒŒì´í”„ë¼ì¸ì´ ë³„ë„ë¡œ ìœ ì§€í•˜ëŠ” ë²„í¼
        # - DL_start.py ë‚´ë¶€ ë²„í¼ì™€ 'ê°™ì€ ê¸¸ì´'ë¡œ ì›€ì§ì´ë©°,
        #   ê° ë°ì´í„°ì— ML ê²°ê³¼ ë“±ì„ ë¶™ì¸ í˜•íƒœë¡œ ë³´ê´€í•©ë‹ˆë‹¤.
        # - êµ¬ì¡° ì˜ˆì‹œ:
        #   {
        #     "origin": {...ì›ë³¸...},
        #     "ml": {...ML ê²°ê³¼...}
        #   }
        self.data_buffer = []

        # 3) ìœˆë„ìš° í¬ê¸° ì €ì¥ (DLê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤)
        self.window_size = PIPELINE_WINDOW_SIZE

        # 4) DL ë‚´ë¶€ ìƒíƒœ ì´ˆê¸°í™”
        # - í˜¹ì‹œ ì´ì „ ì‹¤í–‰ì—ì„œ ë‚¨ì•„ìˆì„ì§€ ëª¨ë¥¼ ë°ì´í„°ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.

        print(f"âœ“ DL ìœˆë„ìš° ì‚¬ì´ì¦ˆ: {self.window_size} (from DL_start.py)")

    def run(self, interval=0.5, max_count=None, loop=False):
        """
        íŒŒì´í”„ë¼ì¸ì„ ì‹¤ì œë¡œ ëŒë¦¬ëŠ” ë©”ì¸ ë£¨í”„.

        íŒŒë¼ë¯¸í„°:
        - interval(float): ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ëŒ€ê¸°í•  ë•Œ, í˜¹ì€ ë‹¨ê³„ ì‚¬ì´ì‚¬ì´ ì‰¬ëŠ” ì‹œê°„(ì´ˆ)
        - max_count(int|None): ì²˜ë¦¬í•  ìµœëŒ€ ë°ì´í„° ê°œìˆ˜ (í…ŒìŠ¤íŠ¸ìš©)
                              ì˜ˆ: 10ì´ë©´ 10ê°œ êº¼ë‚´ì„œ ì²˜ë¦¬í•˜ê³  ì¢…ë£Œ
        - loop(bool): Trueë©´ ë¬´í•œë£¨í”„(ê³„ì† ëŒê¸°), Falseë©´ í•œ ë²ˆë§Œ ëŒê³  ëë‚´ê¸°

        ì‘ë™ ë°©ì‹(í•œ ì‚¬ì´í´):
        - Redisì—ì„œ í•˜ë‚˜ êº¼ë‚´ì„œ(ì—†ìœ¼ë©´ ê¸°ë‹¤ë¦¼),
        - ML -> DL ìˆœì„œë¡œ íƒœìš°ê³ ,
        - DLì´ ì¤€ë¹„ë˜ë©´(ready=True) ê²°ê³¼ë¥¼ ë³´ê³  ì´ìƒì´ë©´ SLM í¬ë§·ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
        """
        print(f"\nğŸš€ S_PipeLine.py ì‹œì‘ (interval={interval}s, loop={loop})")
        print("=" * 80)

        count = 0  # ì§€ê¸ˆê¹Œì§€ ì²˜ë¦¬(êº¼ëƒ„)í•œ ë°ì´í„° ìˆ˜ ì¹´ìš´íŠ¸
        while True:
            # ------------------------------------------------------------
            # [Step 1] Redisì—ì„œ ë°ì´í„° êº¼ë‚´ê¸°
            # - server.pop_oldest()ëŠ” ì œì¼ ì˜¤ë˜ëœ ê±¸ êº¼ë‚¸ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
            # - ê·¸ë¦¬ê³  ì´ë¯¸ {"origin": {...}} í˜•íƒœë¡œ ê°ì‹¸ì„œ ì¤ë‹ˆë‹¤.
            # ------------------------------------------------------------
            wrapped_data = self.server.pop_oldest()

            if not wrapped_data:
                # Redisì— ë‹¹ì¥ êº¼ë‚¼ ë°ì´í„°ê°€ ì—†ì„ ë•Œ
                print("âš ï¸ No data available... waiting.")
                time.sleep(interval)
                # loop=False ì´ë©´ì„œ max_countë„ ì—†ìœ¼ë©´, ê¸°ë‹¤ë ¸ë‹¤ê°€ ë°”ë¡œ ì¢…ë£Œ
                if not loop and not max_count:
                    break
                # ì•„ë‹ˆë©´ ë‹¤ìŒ ë£¨í”„ë¡œ(ì¡°ê¸ˆ ë” ê¸°ë‹¤ë ¸ë‹¤ê°€ ì¬ì‹œë„)
                continue

            count += 1
            # ì›ë³¸ ë°ì´í„°ì— redis_id ê°™ì€ ì‹ë³„ìê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³  í‘œì‹œ
            packet_id = wrapped_data.get("origin", {}).get("redis_id", "-")
            print(f"\n#{count:05d} [Step 1] POP ì„±ê³µ: {packet_id}")

            # ì‹¤ì œ ì›ë³¸ ë°ì´í„° ì¶”ì¶œ(ML/DLì€ 'origin'ë§Œ ë°›ìŠµë‹ˆë‹¤)
            data_origin = wrapped_data["origin"]

            # ------------------------------------------------------------
            # [Step 2] ML ì²˜ë¦¬
            # - ë¹ ë¥´ê²Œ ë‹¨ì¼ ë°ì´í„°ì— ëŒ€í•œ ê°„ë‹¨í•œ íŒë‹¨ì„ ìˆ˜í–‰
            # - ê²°ê³¼ë¥¼ wrapped_data['ml']ì— í•©ì³ ì €ì¥
            # ------------------------------------------------------------
            try:
                ml_output = ML_start(data_origin)
                # ML ê²°ê³¼ê°€ Noneì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ë¹ˆ dictë¡œ ëŒ€ì²´
                wrapped_data["ML"] = ml_output if ml_output else {}
                print(f"    [Step 2] ML ì¶”ë¡ : {wrapped_data['ML'].get('match', 'N/A')}")
            except Exception as e:
                # ML ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆë”ë¼ë„ ì „ì²´ íŒŒì´í”„ë¼ì¸ì´ ë©ˆì¶”ë©´ ì•ˆ ë˜ë¯€ë¡œ,
                # í•´ë‹¹ ë°ì´í„°ëŠ” ê±´ë„ˆë›°ê³  ì¡°ê¸ˆ ì‰¬ì—ˆë‹¤ê°€ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.
                print(f"âŒ [Step 2] ML_start() ì˜¤ë¥˜: {e}")
                time.sleep(interval)
                continue

            # ------------------------------------------------------------
            # [Step 3] DL ì²˜ë¦¬(ìƒíƒœ ê¸°ë°˜, ìœˆë„ìš° í•„ìš”)
            # - DL_startëŠ” 'origin' ë°ì´í„°ë§Œ ë°›ìŠµë‹ˆë‹¤ (ML ê²°ê³¼ëŠ” DL íŒë‹¨ì— ì§ì ‘ ì“°ì´ì§€ ì•ŠìŒ)
            # - ë‚´ë¶€ì ìœ¼ë¡œ ìµœê·¼ ë°ì´í„°ë¥¼ ëª¨ì•„ Nê°œê°€ ë˜ë©´ ready=Trueê°€ ë©ë‹ˆë‹¤.
            # - íŒŒì´í”„ë¼ì¸ë„ ë™ì¼í•œ ê°œìˆ˜ë§Œí¼ ë²„í¼ë¥¼ ìœ ì§€í•˜ì—¬ 'ê·¸ ì‹œì 'ì˜ ë¬¶ìŒì„ ì¬í˜„í•©ë‹ˆë‹¤.
            # ------------------------------------------------------------
            # [Step 3] DL ì²˜ë¦¬(ìƒíƒœ ê¸°ë°˜, ìœˆë„ìš° í•„ìš”)
            try:
                # 1. (ìˆœì„œ ë³€ê²½) ML ê²°ê³¼ë¥¼ í¬í•¨í•œ ë°ì´í„°ë¥¼ ë²„í¼ì— 'ë¨¼ì €' ì €ì¥í•©ë‹ˆë‹¤.
                self.data_buffer.append(wrapped_data)

                # 2. ë²„í¼ê°€ 14ê°œ(window_size)ë§Œí¼ ì°¼ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
                current_buffer_size = len(self.data_buffer)

                if current_buffer_size < self.window_size:
                    # 3. (14ê°œ ë¯¸ë§Œ) ì•„ì§ ë¶€ì¡±í•˜ë©´, DLì„ 'í˜¸ì¶œí•˜ì§€ ì•Šê³ ' ëŒ€ê¸°í•©ë‹ˆë‹¤.
                    print(f"     [Step 3] DL ë²„í¼ë§: [{current_buffer_size}/{self.window_size}]... ëŒ€ê¸°")
                    dl_output = None # ğŸ‘ˆ DL ê²°ê³¼ê°€ ì—†ìŒì„ ëª…í™•íˆ í•©ë‹ˆë‹¤.
                else:
                    # 4. (14ê°œ ë‹¬ì„±) 14ê°œê°€ ëª¨ì˜€ìœ¼ë©´, ë²„í¼ì—ì„œ 14ê°œ ë¬¶ìŒ(batch)ì„ ìº¡ì²˜í•©ë‹ˆë‹¤.
                    #    (S_PipeLineì€ {origin, ml} ë¬¶ìŒì„ ë²„í¼ë§í•©ë‹ˆë‹¤)
                    current_window_batch = self.data_buffer[-self.window_size:]

                    print(f"     [Step 3] DL ë²„í¼ë§: [{current_buffer_size}/{self.window_size}]... ğŸš€ 14ê°œ ë¬¶ìŒìœ¼ë¡œ DL ì¶”ë¡ !")

                    # 5. DL_startì— 14ê°œ ë¬¶ìŒ(batch)ì„ í•œ ë²ˆì— ì „ë‹¬í•©ë‹ˆë‹¤.
                    #    (DL_start.pyëŠ” {origin, ml} ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ ì²˜ë¦¬í•©ë‹ˆë‹¤)
                    dl_output = DL_start(current_window_batch) 

            except Exception as e:
                # DL ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆë”ë¼ë„ ì „ì²´ íŒŒì´í”„ë¼ì¸ì´ ë©ˆì¶”ë©´ ì•ˆ ë˜ë¯€ë¡œ,
                # í•´ë‹¹ ë°ì´í„°ëŠ” ê±´ë„ˆë›°ê³  ì¡°ê¸ˆ ì‰¬ì—ˆë‹¤ê°€ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.
                print(f"âŒ [Step 3] DL_start() ì˜¤ë¥˜: {e}")
                time.sleep(interval)
                continue

            # (ì´ì „ ì½”ë“œ ì‚­ì œ) if not dl_output.get("ready"): ... ë¶€ë¶„ì€ ì‚­ì œí•©ë‹ˆë‹¤.

            # 6. (ìƒˆë¡œ ì¶”ê°€) DL ê²°ê³¼ê°€ ì—†ìœ¼ë©´(ë²„í¼ë§ ì¤‘ì´ë©´) ë‹¤ìŒ ë£¨í”„ë¡œ ê°‘ë‹ˆë‹¤.
            if not dl_output:
                time.sleep(interval)
                continue

            # ------------------------------------------------------------
            # ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ë©´: DL ìœˆë„ìš°ê°€ 'ë”±' ì±„ì›Œì ¸, ë°©ê¸ˆ íŒë‹¨ì´ ëë‚œ ì‹œì ì…ë‹ˆë‹¤.
            # ------------------------------------------------------------

            # (L:231ì˜ current_window_batch ë¡œì§ì€ ì´ë¯¸ ìœ„ì—ì„œ ì‹¤í–‰í–ˆìœ¼ë¯€ë¡œ ì‚­ì œ)
            # current_window_batch = self.data_buffer[-self.window_size:] # ğŸ‘ˆ ì´ ì¤„ ì‚­ì œ

            # (L:236ì˜ ë²„í¼ ìŠ¬ë¼ì´ë”© ë¡œì§ì€ 'ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤')
            if len(self.data_buffer) > self.window_size:
                self.data_buffer = self.data_buffer[-(self.window_size - 1):]

            # ------------------------------------------------------------
            # ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ë©´: DL ìœˆë„ìš°ê°€ 'ë”±' ì±„ì›Œì ¸, ë°©ê¸ˆ íŒë‹¨ì´ ëë‚œ ì‹œì ì…ë‹ˆë‹¤.
            # ------------------------------------------------------------

            # DL_start.pyê°€ ë‚´ë¶€ì—ì„œ '_seq_buffer[-SEQ_LEN:]'ë¡œ ë¬¶ìŒì„ ë³´ì•˜ë‹¤ê³  ê°€ì •í•˜ë¯€ë¡œ,
            # ìš°ë¦¬ë„ ë™ì¼í•˜ê²Œ 'ë§ˆì§€ë§‰ Nê°œ'ë¥¼ ìº¡ì²˜í•´ì•¼ ê°™ì€ ë¬¶ìŒì´ ë©ë‹ˆë‹¤.
            current_window_batch = self.data_buffer[-self.window_size:]

            # ì´ì œ íŒŒì´í”„ë¼ì¸ì˜ ë²„í¼ë„ 'ìŠ¬ë¼ì´ë”©'í•©ë‹ˆë‹¤.
            # DL_start.pyê°€ ë‚´ë¶€ ë²„í¼ë¥¼ [-SEQ_LEN+1:]ë¡œ ìŠ¬ë¼ì´ë“œ(=N-1ê°œ ë‚¨ê¹€) í–ˆë‹¤ë©´,
            # ìš°ë¦¬ë„ ë™ì¼í•˜ê²Œ N-1ê°œë§Œ ë‚¨ê¸°ê³  ë‹¤ìŒ ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
            if len(self.data_buffer) > self.window_size:
                # ì˜ˆ) N=5ë¼ë©´, 5ê°œë¥¼ ë³¸ ë’¤ ë‹¤ìŒì—ëŠ” 4ê°œë§Œ ìœ ì§€í•˜ê³  ìƒˆë¡œ 1ê°œ ë“¤ì–´ì˜¤ë©´ ë‹¤ì‹œ 5ê°œê°€ ë¨
                self.data_buffer = self.data_buffer[-(self.window_size - 1):]

            # ------------------------------------------------------------
            # [Step 4] Alert íŒë‹¨
            # - DLì˜ label ë‚´ìš©ìœ¼ë¡œ ì´ìƒ/ì •ìƒ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
            # - ê´€ë¡€: label ì•ˆì— "ğŸ”´ Anomaly"ê°€ ìˆìœ¼ë©´ ì´ìƒ(O), ì•„ë‹ˆë©´ ì •ìƒ(X)
            # ------------------------------------------------------------
            # [Step 4] Alert íŒë‹¨
            # DL_start.pyëŠ” {"alert": "o"|"x", "dl": {"reconstruction_mse": ...}} ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

            # 'alert' í‚¤ë¥¼ ì§ì ‘ ì½ì–´ì˜µë‹ˆë‹¤.
            alert_status = "O" if dl_output.get("alert") == "o" else "X"

            # S_PipeLineì´ ì‚¬ìš©í•˜ë˜ 'label' ë³€ìˆ˜ë¥¼ DL ê²°ê³¼ì— ë§ê²Œ ìƒì„±í•´ì¤ë‹ˆë‹¤.
            label = "ğŸ”´ Anomaly" if alert_status == "O" else "ğŸŸ¢ Normal"

            # 'dl' ë”•ì…”ë„ˆë¦¬ ì•ˆì—ì„œ 'reconstruction_mse' ê°’ì„ ì •í™•íˆ ì°¾ìŠµë‹ˆë‹¤.
            mse = dl_output.get("dl", {}).get("reconstruction_mse", -1)

            # ìˆ˜ì •ëœ 'label'ê³¼ 'mse'ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
            print(f" 	[Step 4] DL Alert: '{alert_status}' ({label}) (MSE={mse:.6f})")

            if alert_status == "X":
                # ì •ìƒì¸ ê²½ìš°: í•´ë‹¹ ë¬¶ìŒì€ ë²„ë¦¬ê³  ë‹¤ìŒ ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
                print("    [Step 4] 'X'(ì •ìƒ) - ë°°ì¹˜ ë“œë.")
                time.sleep(interval)
                continue

            # ------------------------------------------------------------
            # [Step 5] ì´ìƒ(O)ì¸ ê²½ìš°: SLM í¬ë§·ìœ¼ë¡œ 'ìœˆë„ìš° ì „ì²´'ë¥¼ ì¤€ë¹„
            # - DL ê²°ê³¼ëŠ” ìœˆë„ìš° ì „ì²´ì— ëŒ€í•œ 'í•˜ë‚˜ì˜ ê²°ê³¼'ì´ë¯€ë¡œ,
            #   ìœˆë„ìš°ì— ë“¤ì–´ìˆë˜ ê° íŒ¨í‚·ì— ë™ì¼í•œ DL ê²°ê³¼ dictë¥¼ ë³‘í•©í•©ë‹ˆë‹¤.
            # ------------------------------------------------------------
            print(f"    [Step 5] 'O'(ì´ìƒ) - ë°ì´í„° ë³‘í•© ì‹œì‘...")

            # DL_start.pyëŠ” ìœˆë„ìš°ì— ëŒ€í•´ ë‹¨ì¼ ê²°ê³¼(dict)ë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.
            dl_result_for_batch = dl_output

            final_batch_for_slm = []  # SLMìœ¼ë¡œ ë³´ë‚¼ ìµœì¢… ë¦¬ìŠ¤íŠ¸(ìœˆë„ìš° í¬ê¸°ë§Œí¼)

            # ë°©ê¸ˆ ìº¡ì²˜í•œ ë¬¶ìŒ(current_window_batch)ì˜ ê° í•­ëª©ì„ ìˆœíšŒí•©ë‹ˆë‹¤.
            for packet_data in current_window_batch:
                # ì›ë³¸ì„ ê±´ë“œë¦¬ì§€ ì•Šê¸° ìœ„í•´ ë³µì‚¬ë³¸ì„ ë§Œë“­ë‹ˆë‹¤.
                packet_data_copy = deepcopy(packet_data)

                # ê° í•­ëª©ì— ë™ì¼í•œ DL ê²°ê³¼ë¥¼ "DL" í‚¤ë¡œ ë¶™ì…ë‹ˆë‹¤.
                packet_data_copy["DL"] = dl_result_for_batch

                # ì•„ë˜ ì£¼ì„ì€ 'alert' í‚¤ë¥¼ ì¶”ê°€í•˜ë˜ ê³¼ê±° í”ì (ì§€ê¸ˆì€ ì‚¬ìš© ì•ˆ í•¨)
                # packet_data_copy["alert"] = alert_status

                final_batch_for_slm.append(packet_data_copy)

            # ------------------------------------------------------------
            # [Step 6] ìµœì¢… ê²°ê³¼ ì¶œë ¥(ì˜ˆ: SLMìœ¼ë¡œ ë„˜ê¸´ë‹¤ê³  ê°€ì •)
            # - ì‹¤ì œ ì‹œìŠ¤í…œì—ì„œëŠ” ì´ ë¶€ë¶„ì—ì„œ ë©”ì‹œì§€ í, HTTP ì „ì†¡ ë“±ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            # - ì§€ê¸ˆì€ 'ì‚¬ëŒì´ ì½ê¸° ì¢‹ì€ í˜•íƒœ'ë¡œ í”„ë¦°íŠ¸í•©ë‹ˆë‹¤.
            # ------------------------------------------------------------
            print("=" * 80)
            print(f"    [Step 6] SLM ì „ì†¡ ë°ì´í„° (ì´ {len(final_batch_for_slm)}ê°œ íŒ¨í‚·)")
            print_safe(final_batch_for_slm)
            print("=" * 80)

            # ------------------------------------------------------------
            # ë£¨í”„ ì œì–´(ì–¸ì œ ë©ˆì¶œì§€)
            # ------------------------------------------------------------
            if max_count and count >= max_count:
                # max_countê°œ ì²˜ë¦¬í–ˆìœ¼ë©´ ì¢…ë£Œ
                print(f"\nâœ… Reached max_count={max_count}. Stopping.")
                break

            if not loop:
                # loop=Falseë©´ í•œ ë²ˆ ëŒê³  ì¢…ë£Œ
                print("\nâ„¹ï¸ Loop disabled. Stopping after one cycle.")
                break

            # ë‹¤ìŒ ë£¨í”„ ì „ ì ê¹ ëŒ€ê¸°
            time.sleep(interval)


# ============================================================
# main: ì»¤ë§¨ë“œë¼ì¸ì—ì„œ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ ì§„ì…í•˜ëŠ” êµ¬ê°„
# ============================================================
def main():
    """
    ëª…ë ¹ì¤„ ì¸ì(ì˜µì…˜) ì •ì˜ ë° íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì§„ì…ì .

    ì£¼ìš” ì˜µì…˜:
    - --host, --port, --db, --password: Redis ì—°ê²° ì •ë³´
    - --interval: ë‹¨ê³„ ì‚¬ì´ì‚¬ì´ ëŒ€ê¸° ì‹œê°„(ì´ˆ)
    - --max: ìµœëŒ€ ëª‡ ê°œì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ë©´ ë©ˆì¶œì§€ (í…ŒìŠ¤íŠ¸ìš©)
    - --loop: ë¬´í•œ ë£¨í”„ë¡œ ê³„ì† ëŒë¦´ì§€ (ì‹¤ì „ìš©)
    """
    parser = argparse.ArgumentParser(
        description="S_PipeLine: Redis -> ML -> DL -> SLM (Stateful DL ë°˜ì˜)"
    )
    # Redis ì—°ê²° ì •ë³´(í•„ìš” ì‹œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
    parser.add_argument("--host", default="localhost")
    parser.add_argument("--port", type=int, default=6379)
    parser.add_argument("--db", type=int, default=0)
    parser.add_argument("--password")

    # íŒŒì´í”„ë¼ì¸ ì£¼ê¸°(ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë‹¨ê³„ ì‚¬ì´ì— ê¸°ë‹¤ë¦´ ì‹œê°„)
    parser.add_argument("--interval", type=float, default=0.5,
                        help="ë°ì´í„° POP ì£¼ê¸° (ì´ˆ)")

    # ì‹¤í–‰ ì œì–´(í…ŒìŠ¤íŠ¸/ìš´ì˜ ëª¨ë“œ ì„ íƒ)
    parser.add_argument("--max", type=int,
                        help="ìµœëŒ€ nê°œ íŒ¨í‚· ì²˜ë¦¬ í›„ ì¢…ë£Œ (í…ŒìŠ¤íŠ¸ìš©)")
    parser.add_argument("--loop", action="store_true",
                        help="ë¬´í•œ ë£¨í”„ë¡œ ì‹¤í–‰ (ì‹¤ì „ìš©)")

    args = parser.parse_args()

    # íŒŒì´í”„ë¼ì¸ ê°ì²´ ë§Œë“¤ê¸°(ì—¬ê¸°ì„œ Redis ì—°ê²° ë“± ì´ˆê¸°í™”)
    pipeline = SequentialPipeLine(
        host=args.host,
        port=args.port,
        db=args.db,
        password=args.password,
    )

    # íŒŒì´í”„ë¼ì¸ ì‹¤í–‰(ì˜µì…˜ì— ë”°ë¼ í•œ ë²ˆë§Œ ëŒê±°ë‚˜ ê³„ì† ë•ë‹ˆë‹¤)
    pipeline.run(interval=args.interval, max_count=args.max, loop=args.loop)
# ì´ íŒŒì¼ì„ ì§ì ‘ ì‹¤í–‰í–ˆì„ ë•Œë§Œ main()ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
# ë‹¤ë¥¸ íŒŒì¼ì—ì„œ import í•˜ëŠ” ê²½ìš°ì—ëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
if __name__ == "__main__":
    main()